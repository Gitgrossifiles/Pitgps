<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1" />
  <title>Pit Locations Map</title>
  <style>
    :root{
      --bg:#f8fafc; --panel:#ffffff; --text:#111827; --muted:#6b7280; --accent:#2563eb; --accent-ink:#ffffff;
      --border:#e5e7eb; --overlay:rgba(0,0,0,.25); --shadow:0 10px 30px rgba(0,0,0,.12);
    }
    *{box-sizing:border-box}
    html,body{
      height:100%;
      margin:0;
      background:var(--bg);
      color:var(--text);
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
    }
    .app{
      display:grid;
      grid-template-columns:360px 1fr;
      height:100%;
    }
    .sidebar{
      background:var(--panel);
      border-right:1px solid var(--border);
      display:flex;
      flex-direction:column;
      z-index:20;
    }
    .header{
      padding:16px;
      border-bottom:1px solid var(--border);
    }
    h1{
      font-size:16px;
      margin:0 0 4px;
      font-weight:800;
    }
    .sub{
      font-size:12px;
      color:var(--muted);
    }
    .controls{
      padding:10px 16px 6px;
      border-bottom:1px solid var(--border);
    }
    .row{display:grid;gap:6px}
    label{font-size:12px;color:var(--muted)}
    input[type=text],
    button{
      width:100%;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:#fff;
      color:var(--text);
      min-height:40px;
      font-size:14px;
    }
    button.primary{
      background:var(--accent);
      color:var(--accent-ink);
      font-weight:600;
      border-color:transparent;
    }
    .list{
      flex:1;
      overflow:auto;
    }
    .item{
      padding:10px 16px;
      border-bottom:1px solid var(--border);
      cursor:pointer;
    }
    .item:hover{background:#f1f5f9}
    .title{
      font-size:14px;
      font-weight:700;
    }
    .meta{
      font-size:12px;
      color:var(--muted);
      margin-top:3px;
    }

    #map{
      height:100%;
      width:100%;
      position:relative;
      z-index:1;
    }

    /* Floating buttons (on top of Leaflet) */
    .fab{
      position:fixed;
      z-index:9999; /* ensure above Leaflet tiles & controls */
      border-radius:999px;
      box-shadow:var(--shadow);
      border:1px solid var(--border);
      background:#fff;
      display:flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      pointer-events:auto;
    }
    /* Menu bottom-left */
    #menuBtn{
      left:12px;
      bottom:16px;
      width:52px;
      height:52px;
      font-size:22px;
    }
    /* Current location above fit button on right */
    #locFab{
      right:12px;
      bottom:84px;
      width:52px;
      height:52px;
      font-size:20px;
    }
    /* Fit-to-pins bottom-right */
    #fitFab{
      right:12px;
      bottom:16px;
      width:56px;
      height:56px;
      font-size:20px;
    }

    /* Mobile drawer overlay */
    #shade{
      position:fixed;
      inset:0;
      background:var(--overlay);
      opacity:0;
      pointer-events:none;
      transition:opacity .25s ease;
      z-index:19;
    }
    #shade.show{
      opacity:1;
      pointer-events:auto;
    }

    /* Make sure Leaflet things are below our fabs */
    .leaflet-pane,
    .leaflet-control-container,
    .leaflet-top,
    .leaflet-bottom{
      z-index:400 !important;
    }

    /* Mobile behavior */
    @media(max-width:900px){
      .app{grid-template-columns:1fr}
      .sidebar{
        position:fixed;
        top:0;
        left:0;
        height:100%;
        width:86vw;
        max-width:420px;
        transform:translateX(-100%);
        transition:transform .28s cubic-bezier(.2,.8,.2,1);
        box-shadow:var(--shadow);
      }
      .sidebar.open{transform:translateX(0)}
      #map{height:100vh}
    }

    .badge{
      font-size:11px;
      color:var(--muted);
    }
  </style>
</head>
<body>
  <div id="shade"></div>
  <button id="menuBtn" class="fab" title="Menu">‚ò∞</button>
  <button id="locFab" class="fab" title="Jump to current location">üìç</button>
  <button id="fitFab" class="fab" title="Fit to pins">üó∫Ô∏è</button>

  <div class="app">
    <aside id="drawer" class="sidebar">
      <div class="header">
        <h1>Pit Locations</h1>
        <div class="sub" id="summary">Loading data‚Ä¶</div>
      </div>

      <div class="controls">
        <div class="row" style="margin-bottom:6px;">
          <button id="reloadBtn" class="primary">Reload preloaded data</button>
        </div>
        <div class="row">
          <label for="search">Search (address, business, description, serial)</label>
          <input id="search" type="text" placeholder="Type to filter‚Ä¶" />
          <button id="clearBtn" style="margin-top:4px;">Clear filter</button>
        </div>

      </div>

      <div id="list" class="list"></div>
    </aside>

    <main id="map"></main>
  </div>

  <!-- Leaflet + MarkerCluster -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"></script>

  <script>
    // --- State ---
    let leafletMap;
    let leafletMarkers = [];
    let leafletCluster = null;
    let dataRows = [];
    let allRows = [];
    let currentLocMarker = null;
    const PRELOAD_URL = './data/pit_locations.json';

    const el = id => document.getElementById(id);
    const fmt = v => (v === undefined || v === null) ? "" : String(v).trim();
    const clamp = (n,min,max) => Math.min(Math.max(n,min),max);

    // --- Drawer & overlay ---
    const drawer = el('drawer');
    const shade = el('shade');

    function openDrawer(){
      drawer.classList.add('open');
      shade.classList.add('show');
    }
    function closeDrawer(){
      drawer.classList.remove('open');
      shade.classList.remove('show');
    }

    el('menuBtn').onclick = () => {
      if (drawer.classList.contains('open')) closeDrawer();
      else openDrawer();
    };
    el('fitFab').onclick = () => fitToPins();
    shade.onclick = closeDrawer;
    window.addEventListener('keydown', e => {
      if (e.key === 'Escape') closeDrawer();
    });

    // --- Current location button ---
    el('locFab').onclick = () => {
      jumpToCurrentLocation();
    };

    function jumpToCurrentLocation(){
      if (!navigator.geolocation){
        alert('Geolocation is not supported by this browser.');
        return;
      }
      navigator.geolocation.getCurrentPosition(
        pos => {
          const { latitude, longitude } = pos.coords;
          const lat = clamp(latitude, -85, 85);
          const lng = clamp(longitude, -180, 180);
          const latlng = L.latLng(lat, lng);

          // Center map
          if (leafletMap){
            leafletMap.setView(latlng, 17);
          }

          // Add or move a marker for current location
          if (currentLocMarker){
            currentLocMarker.setLatLng(latlng);
          } else {
            currentLocMarker = L.marker(latlng, {
              title: 'Your location'
            }).addTo(leafletMap);
          }
        },
        err => {
          console.warn('Geolocation error', err);
          alert('Unable to get current location: ' + err.message);
        },
        {
          enableHighAccuracy: true,
          timeout: 10000,
          maximumAge: 0
        }
      );
    }

    // --- Load data from JSON ---
    async function loadPreloaded(){
      try{
        el('summary').textContent = 'Loading data‚Ä¶';
        const r = await fetch(PRELOAD_URL + '?t=' + Date.now(), {cache:'no-store'});
        if (!r.ok) throw new Error('HTTP ' + r.status);
        const json = await r.json();
        if (!Array.isArray(json)) throw new Error('Invalid JSON: expected array');

        allRows = json.map((o,i)=>({
          rowIndex:i+1,
          lat:Number(o.lat),
          lng:Number(o.lng),
          streetNum:fmt(o.street_num),
          streetDir:fmt(o.street_dir),
          street:fmt(o.street),
          business:fmt(o.business),
          address:[fmt(o.street_num),fmt(o.street_dir),fmt(o.street)]
            .filter(Boolean).join(' ').replace(/\s+/g,' '),
          description:fmt(o.description),
          serial:fmt(o.serial)
        })).filter(d => Number.isFinite(d.lat) && Number.isFinite(d.lng));

        dataRows = allRows.slice();
        renderMarkers();
        renderList(dataRows);
        updateSummary();
        fitToPins();
      }catch(e){
        console.error('Preload error', e);
        el('summary').textContent = 'Failed to load data: ' + e.message;
      }
    }

    el('reloadBtn').onclick = () => {
      loadPreloaded();
    };

    // --- Init Leaflet map ---
    function initMap(){
      leafletMap = L.map('map',{zoomControl:true});
      // Center roughly on Chicago area; fitToPins will adjust once markers loaded
      leafletMap.setView([41.8781,-87.6298], 11);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
        maxZoom:19,
        attribution:'&copy; OpenStreetMap contributors'
      }).addTo(leafletMap);

      // Wire search after map ready
      el('search').addEventListener('input', throttle(applyFilter, 120));
      el('clearBtn').onclick = () => {
        el('search').value = '';
        dataRows = allRows.slice();
        renderMarkers(dataRows);
        renderList(dataRows);
        updateSummary();
        fitToPins();
      };
    }

    // --- Markers ---
    function clearMarkers(){
      if (leafletCluster){
        leafletMap.removeLayer(leafletCluster);
        leafletCluster = null;
      }
      leafletMarkers.forEach(m => leafletMap.removeLayer(m));
      leafletMarkers = [];
    }

    function renderMarkers(rows = dataRows){
      if (!leafletMap) return;
      clearMarkers();
      const clusterGroup = L.markerClusterGroup();

      rows.forEach(d => {
        const lat = clamp(d.lat, -85, 85);
        const lng = clamp(d.lng, -180, 180);
        const marker = L.marker([lat,lng]);
        marker.__row = d;
        marker.on('click', () => openInfo(marker));
        clusterGroup.addLayer(marker);
        leafletMarkers.push(marker);
      });

      leafletCluster = clusterGroup;
      leafletMap.addLayer(leafletCluster);
    }

    function openInfo(marker){
      const d = marker.__row;
      const title = escapeHTML(d.address || '‚Äî');
      const businessLine = d.business
        ? `<div style="font-weight:600;font-size:12px">${escapeHTML(d.business)}</div>`
        : '';
      const html = `
        <div style="min-width:220px">
          <div style="font-weight:800;font-size:14px">${title}</div>
          ${businessLine}
          <div style="color:#64748b;font-size:12px;margin:4px 0 8px">${escapeHTML(d.description || '')}</div>
          <div style="font-size:12px;line-height:1.4">
            <div><b>Serial #:</b> ${escapeHTML(d.serial || '‚Äî')}</div>
            <div><b>Lat/Lng:</b> ${Number(d.lat).toFixed(6)}, ${Number(d.lng).toFixed(6)}</div>
          </div>
        </div>
      `;
      marker.bindPopup(html).openPopup();
    }

    function fitToPins(){
      if (!leafletMap || !leafletMarkers.length) return;
      const b = L.latLngBounds(leafletMarkers.map(m => m.getLatLng()));
      leafletMap.fitBounds(b.pad(0.12));
    }

    // --- Search & list ---
    function applyFilter(){
      const q = el('search').value.trim().toLowerCase();
      if (!q){
        dataRows = allRows.slice();
        renderMarkers(dataRows);
        renderList(dataRows);
        updateSummary();
        return;
      }
      const filtered = allRows.filter(d => {
        const hay = [
          d.address || '',
          d.business || '',
          d.description || '',
          d.serial || ''
        ].join(' | ').toLowerCase();
        return hay.includes(q);
      });
      dataRows = filtered;
      renderMarkers(dataRows);
      renderList(dataRows);
      updateSummary();
    }

    function renderList(rows){
      const list = el('list');
      list.innerHTML = '';
      const frag = document.createDocumentFragment();

      rows.forEach(d => {
        const div = document.createElement('div');
        div.className = 'item';
        div.innerHTML = `
          <div class="title">${escapeHTML(d.address || '(no address)')}</div>
          <div class="meta">${escapeHTML(d.business || '')}</div>
          <div class="meta">${escapeHTML(d.description || '')}</div>
          <div class="meta">
            Serial # ${escapeHTML(d.serial || '‚Äî')}
            ‚Ä¢ ${Number(d.lat).toFixed(5)}, ${Number(d.lng).toFixed(5)}
          </div>
        `;
        div.addEventListener('click', () => {
          const latlng = L.latLng(d.lat, d.lng);
          leafletMap.setView(latlng, Math.max(leafletMap.getZoom(), 16));
          const m = leafletMarkers.find(mk => mk.__row === d);
          if (m) openInfo(m);
          closeDrawer();
        });
        frag.appendChild(div);
      });

      list.appendChild(frag);
    }

    function updateSummary(){
      const total = allRows.length;
      const shown = dataRows.length;
      if (!total){
        el('summary').textContent = 'No pins loaded.';
      } else if (shown === total){
        el('summary').textContent = `${total} pins`;
      } else {
        el('summary').textContent = `${shown} of ${total} pins shown`;
      }
    }

    // --- Utils ---
    function escapeHTML(s){
      return String(s ?? '').replace(/[&<>\"']/g, c => ({
        '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#039;'
      }[c]));
    }

    function throttle(fn,ms){
      let t=0,last=null,queued=false;
      return function(...a){
        const now = Date.now();
        if (!t || now - t >= ms){
          t = now;
          fn.apply(this,a);
        } else if (!queued){
          queued = true;
          last = a;
          setTimeout(() => {
            queued = false;
            t = Date.now();
            fn.apply(this,last);
          }, ms - (now - t));
        }
      };
    }

    // --- Boot ---
    window.addEventListener('load', () => {
      initMap();
      loadPreloaded();
    });
  </script>
</body>
</html>


